<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/jpeg" href="/analytics_event_dump/favicon.jpg" />
  <title>Mock Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
  <style>
    /* Base Styles */
    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: url('/analytics_event_dump/background.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 40px 20px;
      color: #222;
    }

    .container {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(15px) saturate(180%);
      -webkit-backdrop-filter: blur(15px) saturate(180%);
      border-radius: 25px;
      padding: 35px;
      max-width: 1200px;
      width: 100%;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      animation: fadeIn 0.8s ease;
    }

    h2 {
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 30px;
      text-shadow: 0px 3px 8px rgba(0,0,0,0.5);
    }

    /* Form Layout */
    .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
    }

    .left-form {
      flex: 1;
      min-width: 280px;
    }

    .right-buttons {
      flex: 0.6;
      min-width: 200px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 15px;
      border-left: 2px solid rgba(255, 255, 255, 0.3);
      padding-left: 30px;
    }

    /* Labels & Inputs */
    label {
      font-weight: 600;
      display: block;
      margin: 12px 0 6px;
      color: #fff;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.25);
      color: #fff;
      font-size: 15px;
      transition: 0.3s ease;
      outline: none;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #4facfe;
      box-shadow: 0 0 8px rgba(79,172,254,0.6);
      background: rgba(255,255,255,0.35);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: monospace;
    }

    ::placeholder {
      color: rgba(240,240,240,0.7);
    }

    /* Buttons */
    .right-buttons button {
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-create  { background: linear-gradient(135deg, #28a745, #218838); }
    .btn-update  { background: linear-gradient(135deg, #ffc107, #e0a800); color: #222; }
    .btn-fetch   { background: linear-gradient(135deg, #007bff, #0056b3); }
    .btn-delete  { background: linear-gradient(135deg, #dc3545, #a71d2a); }

    .right-buttons button:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    /* Divider */
    .divider {
      border-top: 2px dashed rgba(255,255,255,0.3);
      margin: 40px 0;
    }

    /* Result / Table */
    .result {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(12px);
      padding: 20px;
      border-radius: 15px;
      color: #fff;
      overflow-x: auto;
    }

    pre {
      background: rgba(0,0,0,0.6);
      padding: 12px;
      border-radius: 8px;
      color: #00eaff;
      font-size: 14px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      color: #fff;
      border-radius: 12px;
      overflow: hidden;
    }

    thead {
      background: rgba(0,0,0,0.6);
    }

    thead th {
      padding: 14px;
      text-align: center;
      font-weight: 600;
    }

    tbody td {
      padding: 12px;
      background: rgba(255,255,255,0.1);
      text-align: center;
    }

    tbody tr:hover {
      background: rgba(255,255,255,0.2);
      transition: 0.3s ease;
    }

    tbody td button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      background: #4facfe;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
    }

    tbody td button:hover {
      background: #0056b3;
    }

    /* Pagination */
    #paginationControls button {
      background: #007bff;
      border: none;
      color: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      margin: 4px;
      cursor: pointer;
      transition: 0.3s ease;
    }

    #paginationControls button:hover {
      background: #023d7c;
      transform: translateY(-2px);
    }

    /* Toast */
    .toast {
      visibility: hidden;
      min-width: 260px;
      background-color: rgba(0,0,0,0.85);
      color: #fff;
      text-align: center;
      border-radius: 10px;
      padding: 14px;
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      font-size: 16px;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.5s ease, bottom 0.5s ease;
    }

    .toast.show {
      visibility: visible;
      opacity: 1;
      bottom: 50px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .form-section {
        flex-direction: column;
      }
      .right-buttons {
        border-left: none;
        padding-left: 0;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2><i class="fa-solid fa-database"></i> Mock Data Admin Panel</h2>

    <div class="form-section">
      <div class="left-form">
        <label for="uri">URI</label>
        <input type="text" id="uri" placeholder="/v1/product/details" />

        <label for="vertical">Vertical</label>
        <select id="vertical"></select>

        <label for="method">HTTP Method</label>
        <select id="method">
          <option value="GET">GET</option>
          <option value="POST">POST</option>
          <option value="PUT">PUT</option>
          <option value="DELETE">DELETE</option>
        </select>

        <label for="responseCode">Response Code</label>
        <select id="responseCode">
          <option value="200">200</option>
          <option value="201">201</option>
          <option value="400">400</option>
          <option value="404">404</option>
          <option value="500">500</option>
        </select>

        <label for="response">Response (JSON)</label>
        <textarea id="response" placeholder='{ "message": "Mock response" }'></textarea>
      </div>

      <div class="right-buttons">
        <button class="btn-create" onclick="createMock()"><i class="fa-solid fa-plus"></i> Create</button>
        <button class="btn-update" onclick="updateMock()"><i class="fa-solid fa-pen"></i> Update</button>
        <button class="btn-fetch" onclick="fetchMock()"><i class="fa-solid fa-download"></i> Fetch</button>
        <button class="btn-delete" onclick="deleteMock()"><i class="fa-solid fa-trash"></i> Delete</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="result" id="result">
      <div id="jsonOutput"></div>
      <div id="resultTableWrapper">
        <table id="resultTable" style="display: none;">
          <thead>
            <tr>
              <th>URI</th>
              <th>Vertical</th>
              <th>Method</th>
              <th>Response Code</th>
              <th>Response</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="paginationControls" style="margin-top: 12px; text-align: center;">
        <button id="prevBtn" onclick="prevPage()">Previous</button>
        <span id="pageIndicator" style="margin: 0 10px;"></span>
        <button id="nextBtn" onclick="nextPage()">Next</button>
      </div>
    </div>
  </div>
<script>
  const EXPIRATION_TIME_MS = 30 * 1000;

  function base64ToUint8Array(base64) {
    const raw = atob(base64);
    const bytes = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; ++i) {
      bytes[i] = raw.charCodeAt(i);
    }
    return bytes;
  }

  async function generateToken(base64Secret) {
    const keyBytes = base64ToUint8Array(base64Secret);
    const cryptoKey = await crypto.subtle.importKey(
      'raw',
      keyBytes,
      { name: 'HMAC', hash: 'SHA-256' },
      false,
      ['sign']
    );

    const now = Math.floor(Date.now() / 1000);
    const payload = {
      sub: "mock-admin-auth",
      iat: now,
      exp: now + Math.floor(EXPIRATION_TIME_MS / 1000)
    };

    const header = {
      alg: "HS256",
      typ: "JWT"
    };

    const encode = obj => btoa(JSON.stringify(obj)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');

    const encodedHeader = encode(header);
    const encodedPayload = encode(payload);
    const tokenBody = `${encodedHeader}.${encodedPayload}`;

    const signatureBuffer = await crypto.subtle.sign('HMAC', cryptoKey, new TextEncoder().encode(tokenBody));
    const signatureBase64 = btoa(String.fromCharCode(...new Uint8Array(signatureBuffer)))
      .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');

    return `${tokenBody}.${signatureBase64}`;
  }

     function setCookie(name, value, days = 1, timeoutMs = 1000) {
      const expires = new Date(Date.now() + days * 86400000).toUTCString();
      document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;

      return new Promise((resolve, reject) => {
        const start = Date.now();

        (function waitForCookie() {
          const cookieMatch = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
          if (cookieMatch) {
            resolve(decodeURIComponent(cookieMatch[2]));
          } else if (Date.now() - start > timeoutMs) {
            reject(new Error("Cookie was not set within timeout."));
          } else {
            setTimeout(waitForCookie, 50); // check every 50ms
          }
        })();
      });
    }

    function getCookie(name) {
    
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? decodeURIComponent(match[2]) : null;
    }

    function setLocalStorageAndWait(key, value, timeoutMs = 1000) {
      localStorage.setItem(key, value);

      return new Promise((resolve, reject) => {
        const start = Date.now();

        (function waitForLocalStorage() {
          const stored = getFromLocal(key);
          if (stored !== null) {
            resolve(stored);
          } else if (Date.now() - start > timeoutMs) {
            reject(new Error("Value was not set in localStorage within timeout."));
          } else {
            setTimeout(waitForLocalStorage, 50); // retry every 50ms
          }
        })();
      });
    }

    function getFromLocal(key){
        const value = localStorage.getItem(key);
        return value !== null ? value : null;
    }
    let base64SecretFromServer=getCookie('mock_secret');
    async function jwtFetch(url, options = {}) {
      const token = await generateToken(base64SecretFromServer);
      options.headers = {
        ...(options.headers || {}),
        'Authorization': 'Bearer ' + token,
        'Content-Type': options.headers?.['Content-Type'] || 'application/json'
      };
      return fetch(url, options);
    }
</script>

<script>
    const baseUrl = '/analytics_event_dump/admin/mock-data';
    //const baseUrl = '/admin/mock-data';
    window.onload = async function () {
    document.getElementById("paginationControls").style.display = "none";
        if (base64SecretFromServer) {
          console.log("Secret loaded from cookie:", base64SecretFromServer);
          // Use the secret as needed
        } else {
          fetch(baseUrl + '/jwt', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(res => res.json())
          .then(data => {
            base64SecretFromServer = data.mock_secret;
            setCookie("mock_secret", base64SecretFromServer, 1); // Store for 1 day
            console.log("Secret fetched and stored in cookie:", base64SecretFromServer);
            // Use the secret as needed
          })
          .catch(err => console.error("Error fetching JWT secret:", err));
        }
      populateVerticalDropdown();
    };

    function responseHandler(res) {
      if (res.status === 403) {
        showToast("You must connect VPN first");
        throw new Error("403 - VPN required");
      }
      return res.json();
    }

    function validateUri() {
      const uri = document.getElementById('uri').value.trim();
      if (!uri) {
        showToast("URI field is required for this operation.");
        return false;
      }
      return true;
    }

    function clearDisplay(){
       // Clear previous results
      document.getElementById('jsonOutput').innerHTML = "";
      document.querySelector("#resultTable tbody").innerHTML = "";
      document.getElementById("resultTable").style.display = "none";
      document.getElementById("pageIndicator").textContent = "";
      document.getElementById("paginationControls").style.display = "none"; // hide buttons initially
    }

    function getPayload() {
      let uri = document.getElementById('uri').value.trim();
      let vertical = document.getElementById('vertical').value;
      let method = document.getElementById('method').value;
      let responseCode = parseInt(document.getElementById('responseCode').value);
      let responseStr = document.getElementById('response').value;

      let parsedResponse;
      try {
        parsedResponse = JSON.parse(responseStr);
      } catch (e) {
        showToast('Invalid JSON in response field.');
        throw e;
      }

      return { uri, vertical, method, responseCode, response: parsedResponse };
    }

    function createMock() {
      clearDisplay();
      if (!validateUri()) return;
      let payload = getPayload();
      jwtFetch(baseUrl + '/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(responseHandler)
        .then(showResult);
    }

    function updateMock() {
      clearDisplay();
      if (!validateUri()) return;
      let payload = getPayload();
      jwtFetch(baseUrl + '/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(responseHandler)
        .then(showResult);
    }

    function deleteMock() {
      const uri = encodeURIComponent(document.getElementById('uri').value);
      const vertical = encodeURIComponent(document.getElementById('vertical').value);
      const method = encodeURIComponent(document.getElementById('method').value);
      clearDisplay();
      if (!validateUri()) return;
      jwtFetch(`${baseUrl}/delete?uri=${uri}&vertical=${vertical}&method=${method}`, {
        method: 'DELETE'
      }).then(responseHandler)
        .then(showResult);
    }

    let currentPage = 1;
    const rowsPerPage = 20;
    let fetchedData = [];

function fetchMock() {
  const uri = encodeURIComponent(document.getElementById('uri').value);
  const vertical = encodeURIComponent(document.getElementById('vertical').value);
  const method = encodeURIComponent(document.getElementById('method').value);
  clearDisplay();
  jwtFetch(`${baseUrl}/fetch?uri=${uri}&vertical=${vertical}&method=${method}`)
    .then(res => res.json().then(data => ({ status: res.status, body: data })))
    .then(({ status, body }) => {
      if (status === 200) {
        fetchedData = Array.isArray(body) ? body : [body];
        currentPage = 1;
        showTablePage();
        if (fetchedData.length > 0) {
          document.getElementById("paginationControls").style.display = "block";
        }
      }
      else if(status === 403){
        showToast("You must connect VPN first");
        throw new Error("403 - VPN required");
      }
       else {
        fetchedData = [];
        document.getElementById("jsonOutput").innerHTML = `<pre><code class="json">${JSON.stringify(body, null, 2)}</code></pre>`;
        document.getElementById("paginationControls").style.display = "none";
        document.getElementById("jsonOutput").scrollIntoView({ behavior: 'smooth' });
      }
    })
    .catch(err => {
      document.getElementById("jsonOutput").innerHTML = `<pre>Error: ${err.message}</pre>`;
      document.getElementById("paginationControls").style.display = "none";
    });
}

function populateVerticalDropdown() {
    if(!base64SecretFromServer)
    {
      location.reload();
    }
    jwtFetch(`${baseUrl}/vertical/fetch`)
      .then(res => {
        if (!res.ok){
          showToast("Failed to load verticals");
          throw new Error("Failed to load verticals");
        } 
        return res.json();
      })
      .then(data => {
        const dropdown = document.getElementById("vertical");
        dropdown.innerHTML = ""; // Clear existing options
        data.forEach(v => {
          const option = document.createElement("option");
          option.value = v.verticalName;
          option.textContent = v.verticalName;
          dropdown.appendChild(option);
        });
      })
      .catch(err => {
        showToast("Unable to fetch verticals: " + err.message);
      });
  }

function showTablePage() {
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = fetchedData.slice(start, end);

  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";
  pageData.forEach((entry, i) => {
    let tr = document.createElement("tr");
    const responseId = `resp-${start + i}`;
    tr.innerHTML = `
      <td>${entry.uri}</td>
      <td>${entry.vertical}</td>
      <td>${entry.method}</td>
      <td>${entry.responseCode}</td>
      <td>
        <pre id="${responseId}">${JSON.stringify(entry.response, null, 2)}</pre>
        <button onclick="copyToClipboard('${responseId}')">Copy</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("resultTable").style.display = "table";
  document.getElementById("pageIndicator").textContent = `Page ${currentPage} of ${Math.ceil(fetchedData.length / rowsPerPage)}`;
    // 🔽 Smooth scroll to table
  document.getElementById("resultTable").scrollIntoView({ behavior: 'smooth' });
}

function nextPage() {
  if (currentPage * rowsPerPage < fetchedData.length) {
    currentPage++;
    showTablePage();
  }
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    showTablePage();
  }
}
    function showResult(data) {
      document.getElementById('jsonOutput').innerHTML = `<pre><code class="json">${JSON.stringify(data, null, 2)}</code></pre>`;
      document.getElementById("resultTable").style.display = "none";
      // 🔽 Scroll to result display
      document.getElementById("jsonOutput").scrollIntoView({ behavior: 'smooth' });
    }

    function showTable(dataArray) {
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";
      dataArray.forEach(entry => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${entry.uri}</td>
          <td>${entry.vertical}</td>
          <td>${entry.method}</td>
          <td>${entry.responseCode}</td>
          <td><pre><code class="json">${JSON.stringify(entry.response, null, 2)}</code></pre></td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("resultTable").style.display = "table";
    }

    function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).innerText;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showToast("Response copied to clipboard!");
            }).catch(err => {
                showToast("Failed to copy: " + err);
            });
        } else {
            // Fallback for unsupported browsers or insecure context
            const tempInput = document.createElement("textarea");
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand("copy");
                showToast("Response copied to clipboard!");
            } catch (err) {
                showToast("Fallback copy failed: " + err);
            }
            document.body.removeChild(tempInput);
        }
    }
</script>

<script>
  // 🔔 Toast Notification
  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.innerText = message;
    toast.className = "toast show";
    setTimeout(() => {
      toast.className = toast.className.replace("show", "");
    }, 4000);
  }
</script>
  <div id="toast" class="toast"></div>
</body>
</html>
